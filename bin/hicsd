#!/usr/bin/env python3

"""HiC sunt dracones - Your little helper for the HiC analysis"""

import argparse
import hicsuntdracones.hicpro2homer
import hicsuntdracones.submatrix
import hicsuntdracones.hicmatrix

__author__ = "Konrad Foerstner <konrad@foerstner.org>"
__copyright__ = "2018 by Konrad Foerstner <konrad@foerstner.org>"
__license__ = "ISC license"
__email__ = "konrad@foerstner.org"
__version__ = "0.1.0"


def main():
    """
    The entry point.
    """
    parser = argparse.ArgumentParser()
    subparsers = parser.add_subparsers(help="commands")

    show_version_parser = subparsers.add_parser(
        "version", help="Show version")
    show_version_parser.set_defaults(func=show_version)

    hicpro2homer_parser = subparsers.add_parser(
        "hicpro2homer", help="Convert a matrix in HiC-Pro format to "
        "Homer format")
    hicpro2homer_parser.set_defaults(func=hicpro2homer)
    hicpro2homer_parser.add_argument("--input_bed", "-b", required=True)
    hicpro2homer_parser.add_argument("--input_matrix", "-m", required=True)
    hicpro2homer_parser.add_argument("--output_matrix", "-o", required=True)

    number_of_bins_parser = subparsers.add_parser(
        "number_of_bins", help="Return the number of bins of the matrix")
    number_of_bins_parser.set_defaults(func=number_of_bins)
    number_of_bins_parser.add_argument("--input_matrix", "-m", required=True)

    chromosomes_parser = subparsers.add_parser(
        "chromosomes", help="Return the chromosomes used in the matrix")
    chromosomes_parser.set_defaults(func=chromosomes)
    chromosomes_parser.add_argument("--input_matrix", "-m", required=True)    

    normalize_by_columns_sum_parser = subparsers.add_parser(
        "norm_by_col_sum",
        help="Normalize by column sum to make matrices comparable")
    normalize_by_columns_sum_parser.set_defaults(func=normalize_by_columns_sum)
    normalize_by_columns_sum_parser.add_argument(
        "--input_matrix", "-m", required=True)
    normalize_by_columns_sum_parser.add_argument(
        "--output_matrix", "-o", required=True)

    submatrix_parser = subparsers.add_parser(
        "submatrix", help="Extract submatrices")
    submatrix_parser.set_defaults(func=submatrix)
    submatrix_parser.add_argument(
        "--matrix", "-m", dest="matrix_file", required=True)
    submatrix_parser.add_argument("--output_prefix", "-o", required=True)
    submatrix_parser.add_argument(
        "--keep_pattern", "-k",
        help="Bins matching this pattern are explicitly kept."
        "Removing is stronger than keeping.")
    submatrix_parser.add_argument(
        "--remove_pattern", "-r",
        help="Are explicitly removed. Removing is stronger than keeping")
    submatrix_parser.add_argument("--delimiter", "-d", default="-")

    diff_matrix_parser = subparsers.add_parser(
        "diff_matrix", help="Generate differential matrix by dividing the "
        "values of one matrix by the values of the other.")
    diff_matrix_parser.set_defaults(func=diff_matrix)
    diff_matrix_parser.add_argument("--numerator_matrix", "-n", required=True)
    diff_matrix_parser.add_argument("--denominator_matrix", "-d",
                                    required=True)
    diff_matrix_parser.add_argument("--output_matrix", "-o", required=True)

    matrix_heatmap_parser = subparsers.add_parser(
        "matrix_heatmap", help="Plot interaction matix heatmap")
    matrix_heatmap_parser.set_defaults(func=matrix_heatmap)

    virtual_4C_parser = subparsers.add_parser(
        "virtual_4C", help="Perform virtual 4C analysis")
    virtual_4C_parser.set_defaults(func=virtual_4C)

    dist_dep_decay_parser = subparsers.add_parser(
        "dist_dep_decay", help="Distant dependent decay")
    dist_dep_decay_parser.set_defaults(func=dist_dep_decay)
    # output plot and/or text file

    colocalisation_parser = subparsers.add_parser(
         "colocalisation", help="Perform colocalisation analysis")
    colocalisation_parser.set_defaults(func=colocalisation)

    args = parser.parse_args()
    if "func" in dir(args):
        args.func(args)
    else:
        parser.print_help()

def show_version():
    """
    Version
    """
    print(__version__)

def number_of_bins(args):
    """
    Return the number of bins
    """
    hic_matrix = hicsuntdracones.hicmatrix.HiCMatrix(args.input_matrix)
    print(hic_matrix.number_of_bins)

def chromosomes(args):
    hic_matrix = hicsuntdracones.hicmatrix.HiCMatrix(args.input_matrix)
    print("\n".join(hic_matrix.chromosomes))
    
def hicpro2homer(args):
    """
    Convert a matrix in HiC-Pro format to "Homer format.
    """
    hicsuntdracones.hicpro2homer.hicpro2homer(
        args.input_bed, args.input_matrix, args.output_matrix)

def normalize_by_columns_sum(args):
    hic_matrix = hicsuntdracones.hicmatrix.HiCMatrix(args.input_matrix)
    hic_matrix.normalize_by_columns_sum()
    hic_matrix.save(args.output_matrix)

def submatrix(args):
    """
    Extract a submatrix
    """
    hicsuntdracones.submatrix.extract(
        args.matrix_file, args.output_prefix, args.keep_pattern, args.remove_pattern, args.delimiter)

def matrix_heatmap(args):
    """
    Plot matrix heatmap
    """
    pass

def diff_matrix(args):
    """
    Generate differential matrix by dividing the values of one matrix
    by the values of the other.
    """
    pass

def virtual_4C(args):
    """
    Perform vitural 4C analysis
    """
    pass

def dist_dep_decay(args):
    pass

def colocalisation(args):
    pass

main()
