#!/usr/bin/env python3

"""HiC sunt dracones - Your little helper for the HiC analysis"""

import argparse
import hicsuntdracones.hicpro2homer
import hicsuntdracones.hicmatrix
import hicsuntdracones.colocalization
import hicsuntdracones.diffcolocalization
import hicsuntdracones.distdepdecay

__author__ = "Konrad Foerstner <konrad@foerstner.org>"
__copyright__ = "2018 by Konrad Foerstner <konrad@foerstner.org>"
__license__ = "ISC license"
__email__ = "konrad@foerstner.org"
__version__ = "0.1.0dev"


def main():
    """
    The entry point.
    """
    parser = argparse.ArgumentParser()
    subparsers = parser.add_subparsers(help="commands")

    show_version_parser = subparsers.add_parser(
        "version", help="Show version")
    show_version_parser.set_defaults(func=show_version)

    hicpro2homer_parser = subparsers.add_parser(
        "hicpro2homer", help="Convert a matrix in HiC-Pro format to "
        "Homer format")
    hicpro2homer_parser.set_defaults(func=hicpro2homer)
    hicpro2homer_parser.add_argument("--input_bed", "-b", required=True)
    hicpro2homer_parser.add_argument("--input_matrix", "-m", required=True)
    hicpro2homer_parser.add_argument("--output_matrix", "-o", required=True)

    number_of_bins_parser = subparsers.add_parser(
        "number_of_bins", help="Return the number of bins of the matrix")
    number_of_bins_parser.set_defaults(func=number_of_bins)
    number_of_bins_parser.add_argument("--input_matrix", "-m", required=True)

    chromosomes_parser = subparsers.add_parser(
        "chromosomes", help="Return the chromosomes used in the matrix")
    chromosomes_parser.set_defaults(func=chromosomes)
    chromosomes_parser.add_argument("--input_matrix", "-m", required=True)    

    normalize_by_columns_sum_parser = subparsers.add_parser(
        "norm_by_col_sum",
        help="Normalize by column sum to make matrices comparable")
    normalize_by_columns_sum_parser.set_defaults(func=normalize_by_columns_sum)
    normalize_by_columns_sum_parser.add_argument(
        "--input_matrix", "-m", required=True)
    normalize_by_columns_sum_parser.add_argument(
        "--output_matrix", "-o", required=True)

    submatrix_parser = subparsers.add_parser(
        "submatrix", help="Extract submatrices")
    submatrix_parser.set_defaults(func=submatrix)
    submatrix_parser.add_argument(
        "--input_matrix", "-m", required=True)
    submatrix_parser.add_argument("--output_matrix", "-o", required=True)
    submatrix_parser.add_argument(
        "--keep_pattern", "-k",
        help="Bins matching this pattern are explicitly kept."
        "Removing is stronger than keeping.")
    submatrix_parser.add_argument(
        "--remove_pattern", "-r",
        help="Are explicitly removed. Removing is stronger than keeping")

    diff_matrix_parser = subparsers.add_parser(
        "diff_matrix", help="Generate differential matrix by dividing the "
        "values of one matrix by the values of the other.")
    diff_matrix_parser.set_defaults(func=diff_matrix)
    diff_matrix_parser.add_argument("--numerator_matrix", "-n", required=True)
    diff_matrix_parser.add_argument("--denominator_matrix", "-d",
                                    required=True)
    diff_matrix_parser.add_argument("--pseudocount", "-p", default=0.001,
                                    help="Default 0.001")
    diff_matrix_parser.add_argument(
        "--norm_by_col_sum", "-c", default=False, action="store_true",
        help="Normalize the matrices by column sum before performing "
        "the division.")
    diff_matrix_parser.add_argument("--output_matrix", "-o", required=True)

    heatmap_parser = subparsers.add_parser(
        "heatmap", help="Plot interaction matix heatmap")
    heatmap_parser.set_defaults(func=matrix_heatmap)
    heatmap_parser.add_argument(
        "--matrix", "-m", dest="matrix_file", required=True)
    heatmap_parser.add_argument(
        "--vmin", "-i", type=float, default=None)
    heatmap_parser.add_argument(
        "--vmax", "-a", type=float, default=None)
    heatmap_parser.add_argument(
        "--rotate", "-r", default=False, action="store_true",
        help="Rotate 45 degrees. Pyramids FTW!")
    heatmap_parser.add_argument(
        "--by_chrom", "-c", default=False, action="store_true")
    heatmap_parser.add_argument(
        "--output_pdf", "-p", help="Name of the output file. All figures "
        "will be written into this single file")
    heatmap_parser.add_argument(
        "--output_png_prefix", "-n", help="Prefix for output png files. "
        "Each figure file be stored in a separate file.")
    heatmap_parser.add_argument(
        "--png_dpi", "-e", type=int)
    heatmap_parser.add_argument(
        "--differential", "-d", default=False, action="store_true")

    virtual_4C_parser = subparsers.add_parser(
        "virtual_4C", help="Perform virtual 4C analysis")
    virtual_4C_parser.set_defaults(func=virtual_4C)

    dist_dep_decay_parser = subparsers.add_parser(
        "dist_dep_decay", help="Distant dependent decay")
    dist_dep_decay_parser.set_defaults(func=dist_dep_decay)
    dist_dep_decay_parser.add_argument(
        "--matrix", "-m", dest="matrix_file", required=True)
    dist_dep_decay_parser.add_argument(
        "--bin_size", "-b", required=True, type=int)
    dist_dep_decay_parser.add_argument("--output_prefix", "-o", required=True)
    dist_dep_decay_parser.add_argument(
        "--norm_by_col_sum", "-c", default=False, action="store_true",
        help="Normalize the matrices by column sum before performing "
        "the division.")

    colocalisation_parser = subparsers.add_parser(
         "colo", help="Perform colocalisation analysis")
    colocalisation_parser.set_defaults(func=colocalisation)
    colocalisation_parser.add_argument("--matrix", "-m", dest="matrix_file", required=True)
    colocalisation_parser.add_argument("--gff", "-g", dest="gff_file", required=True)
    colocalisation_parser.add_argument("--feature", "-f", required=True)
    colocalisation_parser.add_argument("--bin_size", "-b", required=True, type=int)
    colocalisation_parser.add_argument(
        "--number_of_subsamplings", "-s", default=1, type=int, help="Default 1")
    colocalisation_parser.add_argument("--output_prefix", "-o", required=True)
    colocalisation_parser.add_argument(
        "--margin", "-r", default=0, type=int, help="Default 0")
    colocalisation_parser.add_argument(
        "--flanks_only", "-l", default=False, action="store_true")
    colocalisation_parser.add_argument(
        "--remove_zeros", "-z", default=False, action="store_true")

    diff_colocalisation_parser = subparsers.add_parser(
         "colo_diff", help="Perform differential colocalisation analysis")
    diff_colocalisation_parser.set_defaults(func=diff_colocalisation)
    diff_colocalisation_parser.add_argument(
        "--matrix_1", "-1", dest="matrix_file_1", required=True)
    diff_colocalisation_parser.add_argument(
        "--matrix_2", "-2", dest="matrix_file_2", required=True)    
    diff_colocalisation_parser.add_argument("--gff", "-g", dest="gff_file", required=True)
    diff_colocalisation_parser.add_argument("--feature", "-f", required=True)
    diff_colocalisation_parser.add_argument("--bin_size", "-b", required=True, type=int)
    diff_colocalisation_parser.add_argument(
        "--number_of_subsamplings", "-s", default=1, type=int, help="Default 1")
    diff_colocalisation_parser.add_argument("--output_prefix", "-o", required=True)
    diff_colocalisation_parser.add_argument(
        "--margin", "-r", default=0, type=int, help="Default 0")
    diff_colocalisation_parser.add_argument(
        "--flanks_only", "-l", default=False, action="store_true")
    diff_colocalisation_parser.add_argument(
        "--remove_zeros", "-z", default=False, action="store_true")    

    args = parser.parse_args()
    if "func" in dir(args):
        args.func(args)
    else:
        parser.print_help()

def show_version():
    """
    Version
    """
    print(__version__)

def number_of_bins(args):
    """
    Return the number of bins
    """
    hic_matrix = hicsuntdracones.hicmatrix.read_hic_matrix(args.input_matrix)
    print(hic_matrix.number_of_bins)

def chromosomes(args):
    hic_matrix = hicsuntdracones.hicmatrix.read_hic_matrix(args.input_matrix)
    print("\n".join(hic_matrix.chromosomes))
    
def hicpro2homer(args):
    """
    Convert a matrix in HiC-Pro format to "Homer format.
    """
    hicsuntdracones.hicpro2homer.hicpro2homer(
        args.input_bed, args.input_matrix, args.output_matrix)

def normalize_by_columns_sum(args):
    hic_matrix = hicsuntdracones.hicmatrix.read_hic_matrix(args.input_matrix)
    hic_matrix.normalize_by_columns_sum()
    hic_matrix.save(args.output_matrix)

def submatrix(args):
    """
    Extract a submatrix
    """
    hic_matrix = hicsuntdracones.hicmatrix.read_hic_matrix(args.input_matrix)
    hic_matrix.select(
        keep_pattern=args.keep_pattern,
        remove_pattern=args.remove_pattern,
        inplace=True)
    hic_matrix.save(args.output_matrix)

def matrix_heatmap(args):
    """
    Plot matrix heatmap
    """
    hic_matrix = hicsuntdracones.hicmatrix.read_hic_matrix(args.matrix_file)
    hic_matrix.heatmap(
        vmin=args.vmin, vmax=args.vmax, by_chrom=args.by_chrom,
        rotate=args.rotate, output_pdf=args.output_pdf,
        output_png_prefix=args.output_png_prefix, png_dpi=args.png_dpi,
        differential=args.differential)

def diff_matrix(args):
    """
    Generate differential matrix by dividing the values of one matrix
    by the values of the other.
    """
    hic_matrix_numerator = hicsuntdracones.hicmatrix.read_hic_matrix(
        args.numerator_matrix)
    hic_matrix_denominator_matrix = hicsuntdracones.hicmatrix.read_hic_matrix(
        args.denominator_matrix)
    if args.norm_by_col_sum:
        hic_matrix_numerator.normalize_by_columns_sum()
        hic_matrix_denominator_matrix.normalize_by_columns_sum()
    hic_matrix_numerator.div_by(hic_matrix_denominator_matrix, inplace=True)
    hic_matrix_numerator.save(args.output_matrix)

def virtual_4C(args):
    """
    Perform virtual 4C analysis
    """
    pass

def colocalisation(args):
    hicsuntdracones.colocalization.analyse_colocalization(args)

def diff_colocalisation(args):
    hicsuntdracones.diffcolocalization.analyse_diff_colocalization(args)

def dist_dep_decay(args):
    dist_dep_decay_output_generator = (
        hicsuntdracones.distdepdecay.DistDepDecayOutputGenerator(
            args.matrix_file, args.bin_size, args.output_prefix))
    dist_dep_decay_output_generator.write_table_file()
    dist_dep_decay_output_generator.plot_bin_averages()
    dist_dep_decay_output_generator.plot_bin_averages_with_error_bars()
    dist_dep_decay_output_generator.plot_all_values()

main()
